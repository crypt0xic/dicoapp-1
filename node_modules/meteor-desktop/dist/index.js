"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _exports;

var _runtime = _interopRequireDefault(require("regenerator-runtime/runtime"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _shelljs = _interopRequireDefault(require("shelljs"));

var _env = _interopRequireDefault(require("./env"));

var _electron = _interopRequireDefault(require("./electron"));

var _log = _interopRequireDefault(require("./log"));

var _desktop = _interopRequireDefault(require("./desktop"));

var _electronApp = _interopRequireDefault(require("./electronApp"));

var _meteorApp = _interopRequireDefault(require("./meteorApp"));

var _electronBuilder = _interopRequireDefault(require("./electronBuilder"));

var _packager = _interopRequireDefault(require("./packager"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } } function _next(value) { step("next", value); } function _throw(err) { step("throw", err); } _next(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

_shelljs.default.config.fatal = true;
/**
 * Exists
 * @param {string} pathToCheck
 * @returns {boolean}
 */

function exists(pathToCheck) {
  try {
    _fs.default.accessSync(pathToCheck);

    return true;
  } catch (e) {
    return false;
  }
}
/**
 * Symlink exists
 * @param {string} pathToCheck
 * @returns {boolean}
 */


function symlinkExists(pathToCheck) {
  try {
    _fs.default.readlinkSync(pathToCheck);

    return true;
  } catch (e) {
    return false;
  }
}
/**
 * Simple wrapper for shelljs.rm with additional retries in case of failure.
 * It is useful when something is concurrently reading the dir you want to remove.
 */


function rmWithRetries() {
  for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
    args[_key] = arguments[_key];
  }

  var retries = 0;
  return new Promise(function (resolve, reject) {
    function rm() {
      for (var _len2 = arguments.length, rmArgs = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        rmArgs[_key2] = arguments[_key2];
      }

      try {
        _shelljs.default.config.fatal = true;

        _shelljs.default.rm.apply(_shelljs.default, rmArgs);

        _shelljs.default.config.reset();

        resolve();
      } catch (e) {
        retries += 1;

        if (retries < 5) {
          setTimeout(function () {
            rm.apply(void 0, rmArgs);
          }, 100);
        } else {
          _shelljs.default.config.reset();

          reject(e);
        }
      }
    }

    rm.apply(void 0, args);
  });
}
/**
 * Main entity.
 * @class
 * @property {Env} env
 * @property {Electron} electron
 * @property {InstallerBuilder} installerBuilder
 * @property {ElectronApp} electronApp
 * @property {Desktop} desktop
 * @property {MeteorApp} meteorApp
 */


var MeteorDesktop =
/*#__PURE__*/
function () {
  /**
   * @param {string} input        - Meteor app dir
   * @param {string} output       - output dir for bundle/package/installer
   * @param {Object} options      - options from cli.js
   * @param {Object} dependencies - dependencies object
   * @constructor
   */
  function MeteorDesktop(input, output, options, dependencies) {
    _classCallCheck(this, MeteorDesktop);

    var Log = dependencies.log;
    this.log = new Log('index');
    this.version = this.getVersion();
    this.log.info('initializing');
    this.env = new _env.default(input, output, options);
    this.electron = new _electron.default(this);
    this.electronBuilder = new _electronBuilder.default(this);
    this.electronApp = new _electronApp.default(this);
    this.desktop = new _desktop.default(this);
    this.meteorApp = new _meteorApp.default(this);
    this.packager = new _packager.default(this);
    this.utils = {
      exists,
      rmWithRetries,
      symlinkExists
    };
  }
  /**
   * Tries to read the version from our own package.json.
   *
   * @returns {string}
   */


  _createClass(MeteorDesktop, [{
    key: "getVersion",
    value: function getVersion() {
      if (this.version) {
        return this.version;
      }

      var version = null;

      try {
        var _JSON$parse = JSON.parse(_fs.default.readFileSync(_path.default.join(__dirname, '..', 'package.json'), 'UTF-8'));

        version = _JSON$parse.version;
      } catch (e) {
        this.log.error(`error while trying to read ${_path.default.join(__dirname, 'package.json')}`, e);
        process.exit(1);
      }

      return version;
    }
    /**
     * Tries to read the version from our own package.json.
     *
     * @returns {string}
     */

  }, {
    key: "getElectronVersion",
    value: function getElectronVersion() {
      var version = null;

      try {
        version = JSON.parse(_fs.default.readFileSync(_path.default.join(__dirname, '..', 'package.json'), 'UTF-8')).dependencies.electron;
      } catch (e) {
        this.log.error(`error while trying to read ${_path.default.join(__dirname, 'package.json')}` + 'or the electron version from it', e);
        process.exit(1);
      }

      return version;
    }
  }, {
    key: "init",
    value: function init() {
      this.desktop.scaffold();
      this.meteorApp.updateGitIgnore();
    }
  }, {
    key: "buildInstaller",
    value: function () {
      var _buildInstaller = _asyncToGenerator(
      /*#__PURE__*/
      _runtime.default.mark(function _callee() {
        return _runtime.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                this.env.options.installerBuild = true;
                _context.next = 3;
                return this.electronApp.build();

              case 3:
                _context.prev = 3;
                _context.next = 6;
                return this.electronBuilder.build();

              case 6:
                _context.next = 11;
                break;

              case 8:
                _context.prev = 8;
                _context.t0 = _context["catch"](3);
                this.log.error('error occurred while building installer', _context.t0);

              case 11:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this, [[3, 8]]);
      }));

      return function buildInstaller() {
        return _buildInstaller.apply(this, arguments);
      };
    }()
  }, {
    key: "run",
    value: function () {
      var _run = _asyncToGenerator(
      /*#__PURE__*/
      _runtime.default.mark(function _callee2() {
        return _runtime.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                _context2.next = 2;
                return this.electronApp.build(true);

              case 2:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      return function run() {
        return _run.apply(this, arguments);
      };
    }()
  }, {
    key: "build",
    value: function () {
      var _build = _asyncToGenerator(
      /*#__PURE__*/
      _runtime.default.mark(function _callee3() {
        return _runtime.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.next = 2;
                return this.electronApp.build();

              case 2:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      return function build() {
        return _build.apply(this, arguments);
      };
    }()
  }, {
    key: "justRun",
    value: function justRun() {
      this.electron.run();
    }
  }, {
    key: "runPackager",
    value: function () {
      var _runPackager = _asyncToGenerator(
      /*#__PURE__*/
      _runtime.default.mark(function _callee4() {
        var _this = this;

        return _runtime.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                _context4.next = 2;
                return this.electronApp.build();

              case 2:
                this.packager.packageApp().catch(function (e) {
                  _this.log.error(`while trying to build a package an error occurred: ${e}`);
                });

              case 3:
              case "end":
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));

      return function runPackager() {
        return _runPackager.apply(this, arguments);
      };
    }()
  }]);

  return MeteorDesktop;
}();

function _exports(input, output, options) {
  var _ref = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {
    log: _log.default
  },
      _ref$log = _ref.log,
      log = _ref$log === void 0 ? _log.default : _ref$log;

  return new MeteorDesktop(input, output, options, {
    log
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9pbmRleC5qcyJdLCJuYW1lcyI6WyJjb25maWciLCJmYXRhbCIsImV4aXN0cyIsInBhdGhUb0NoZWNrIiwiYWNjZXNzU3luYyIsImUiLCJzeW1saW5rRXhpc3RzIiwicmVhZGxpbmtTeW5jIiwicm1XaXRoUmV0cmllcyIsImFyZ3MiLCJyZXRyaWVzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJybSIsInJtQXJncyIsInJlc2V0Iiwic2V0VGltZW91dCIsIk1ldGVvckRlc2t0b3AiLCJpbnB1dCIsIm91dHB1dCIsIm9wdGlvbnMiLCJkZXBlbmRlbmNpZXMiLCJMb2ciLCJsb2ciLCJ2ZXJzaW9uIiwiZ2V0VmVyc2lvbiIsImluZm8iLCJlbnYiLCJlbGVjdHJvbiIsImVsZWN0cm9uQnVpbGRlciIsImVsZWN0cm9uQXBwIiwiZGVza3RvcCIsIm1ldGVvckFwcCIsInBhY2thZ2VyIiwidXRpbHMiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJqb2luIiwiX19kaXJuYW1lIiwiZXJyb3IiLCJwcm9jZXNzIiwiZXhpdCIsInNjYWZmb2xkIiwidXBkYXRlR2l0SWdub3JlIiwiaW5zdGFsbGVyQnVpbGQiLCJidWlsZCIsInJ1biIsInBhY2thZ2VBcHAiLCJjYXRjaCIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7O0FBRUEsaUJBQU1BLE1BQU4sQ0FBYUMsS0FBYixHQUFxQixJQUFyQjtBQUVBOzs7Ozs7QUFLQSxTQUFTQyxNQUFULENBQWdCQyxXQUFoQixFQUE2QjtBQUN6QixNQUFJO0FBQ0EsZ0JBQUdDLFVBQUgsQ0FBY0QsV0FBZDs7QUFDQSxXQUFPLElBQVA7QUFDSCxHQUhELENBR0UsT0FBT0UsQ0FBUCxFQUFVO0FBQ1IsV0FBTyxLQUFQO0FBQ0g7QUFDSjtBQUdEOzs7Ozs7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QUM3QyxDQUFELEVBQU87QUFDcEMsd0JBQUttQixHQUFMLENBQVNpQixLQUFULENBQWdCLHNEQUFxRHBDLENBQUUsRUFBdkU7QUFDSCxpQkFGRDs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU1PLFNBQVM4QyxRQUFULENBQWlCaEMsS0FBakIsRUFBd0JDLE1BQXhCLEVBQWdDQyxPQUFoQyxFQUE2RTtBQUFBLGlGQUFqQjtBQUFFRztBQUFGLEdBQWlCO0FBQUEsc0JBQWxDQSxHQUFrQztBQUFBLE1BQWxDQSxHQUFrQzs7QUFDeEYsU0FBTyxJQUFJTixhQUFKLENBQWtCQyxLQUFsQixFQUF5QkMsTUFBekIsRUFBaUNDLE9BQWpDLEVBQTBDO0FBQUVHO0FBQUYsR0FBMUMsQ0FBUDtBQUNIIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlZ2VuZXJhdG9yUnVudGltZSBmcm9tICdyZWdlbmVyYXRvci1ydW50aW1lL3J1bnRpbWUnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHNoZWxsIGZyb20gJ3NoZWxsanMnO1xuaW1wb3J0IEVudiBmcm9tICcuL2Vudic7XG5pbXBvcnQgRWxlY3Ryb24gZnJvbSAnLi9lbGVjdHJvbic7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nJztcbmltcG9ydCBEZXNrdG9wIGZyb20gJy4vZGVza3RvcCc7XG5pbXBvcnQgRWxlY3Ryb25BcHAgZnJvbSAnLi9lbGVjdHJvbkFwcCc7XG5pbXBvcnQgTWV0ZW9yQXBwIGZyb20gJy4vbWV0ZW9yQXBwJztcbmltcG9ydCBFbGVjdHJvbkJ1aWxkZXIgZnJvbSAnLi9lbGVjdHJvbkJ1aWxkZXInO1xuaW1wb3J0IFBhY2thZ2VyIGZyb20gJy4vcGFja2FnZXInO1xuXG5zaGVsbC5jb25maWcuZmF0YWwgPSB0cnVlO1xuXG4vKipcbiAqIEV4aXN0c1xuICogQHBhcmFtIHtzdHJpbmd9IHBhdGhUb0NoZWNrXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn1cbiAqL1xuZnVuY3Rpb24gZXhpc3RzKHBhdGhUb0NoZWNrKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgZnMuYWNjZXNzU3luYyhwYXRoVG9DaGVjayk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cblxuXG4vKipcbiAqIFN5bWxpbmsgZXhpc3RzXG4gKiBAcGFyYW0ge3N0cmluZ30gcGF0aFRvQ2hlY2tcbiAqIEByZXR1cm5zIHtib29sZWFufVxuICovXG5mdW5jdGlvbiBzeW1saW5rRXhpc3RzKHBhdGhUb0NoZWNrKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgZnMucmVhZGxpbmtTeW5jKHBhdGhUb0NoZWNrKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuXG4vKipcbiAqIFNpbXBsZSB3cmFwcGVyIGZvciBzaGVsbGpzLnJtIHdpdGggYWRkaXRpb25hbCByZXRyaWVzIGluIGNhc2Ugb2YgZmFpbHVyZS5cbiAqIEl0IGlzIHVzZWZ1bCB3aGVuIHNvbWV0aGluZyBpcyBjb25jdXJyZW50bHkgcmVhZGluZyB0aGUgZGlyIHlvdSB3YW50IHRvIHJlbW92ZS5cbiAqL1xuZnVuY3Rpb24gcm1XaXRoUmV0cmllcyguLi5hcmdzKSB7XG4gICAgbGV0IHJldHJpZXMgPSAwO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGZ1bmN0aW9uIHJtKC4uLnJtQXJncykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBzaGVsbC5jb25maWcuZmF0YWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHNoZWxsLnJtKC4uLnJtQXJncyk7XG4gICAgICAgICAgICAgICAgc2hlbGwuY29uZmlnLnJlc2V0KCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIHJldHJpZXMgKz0gMTtcbiAgICAgICAgICAgICAgICBpZiAocmV0cmllcyA8IDUpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBybSguLi5ybUFyZ3MpO1xuICAgICAgICAgICAgICAgICAgICB9LCAxMDApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNoZWxsLmNvbmZpZy5yZXNldCgpO1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJtKC4uLmFyZ3MpO1xuICAgIH0pO1xufVxuXG4vKipcbiAqIE1haW4gZW50aXR5LlxuICogQGNsYXNzXG4gKiBAcHJvcGVydHkge0Vudn0gZW52XG4gKiBAcHJvcGVydHkge0VsZWN0cm9ufSBlbGVjdHJvblxuICogQHByb3BlcnR5IHtJbnN0YWxsZXJCdWlsZGVyfSBpbnN0YWxsZXJCdWlsZGVyXG4gKiBAcHJvcGVydHkge0VsZWN0cm9uQXBwfSBlbGVjdHJvbkFwcFxuICogQHByb3BlcnR5IHtEZXNrdG9wfSBkZXNrdG9wXG4gKiBAcHJvcGVydHkge01ldGVvckFwcH0gbWV0ZW9yQXBwXG4gKi9cbmNsYXNzIE1ldGVvckRlc2t0b3Age1xuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpbnB1dCAgICAgICAgLSBNZXRlb3IgYXBwIGRpclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBvdXRwdXQgICAgICAgLSBvdXRwdXQgZGlyIGZvciBidW5kbGUvcGFja2FnZS9pbnN0YWxsZXJcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAgICAgIC0gb3B0aW9ucyBmcm9tIGNsaS5qc1xuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkZXBlbmRlbmNpZXMgLSBkZXBlbmRlbmNpZXMgb2JqZWN0XG4gICAgICogQGNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoaW5wdXQsIG91dHB1dCwgb3B0aW9ucywgZGVwZW5kZW5jaWVzKSB7XG4gICAgICAgIGNvbnN0IExvZyA9IGRlcGVuZGVuY2llcy5sb2c7XG4gICAgICAgIHRoaXMubG9nID0gbmV3IExvZygnaW5kZXgnKTtcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gdGhpcy5nZXRWZXJzaW9uKCk7XG5cbiAgICAgICAgdGhpcy5sb2cuaW5mbygnaW5pdGlhbGl6aW5nJyk7XG5cbiAgICAgICAgdGhpcy5lbnYgPSBuZXcgRW52KGlucHV0LCBvdXRwdXQsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmVsZWN0cm9uID0gbmV3IEVsZWN0cm9uKHRoaXMpO1xuICAgICAgICB0aGlzLmVsZWN0cm9uQnVpbGRlciA9IG5ldyBFbGVjdHJvbkJ1aWxkZXIodGhpcyk7XG4gICAgICAgIHRoaXMuZWxlY3Ryb25BcHAgPSBuZXcgRWxlY3Ryb25BcHAodGhpcyk7XG4gICAgICAgIHRoaXMuZGVza3RvcCA9IG5ldyBEZXNrdG9wKHRoaXMpO1xuICAgICAgICB0aGlzLm1ldGVvckFwcCA9IG5ldyBNZXRlb3JBcHAodGhpcyk7XG4gICAgICAgIHRoaXMucGFja2FnZXIgPSBuZXcgUGFja2FnZXIodGhpcyk7XG4gICAgICAgIHRoaXMudXRpbHMgPSB7XG4gICAgICAgICAgICBleGlzdHMsXG4gICAgICAgICAgICBybVdpdGhSZXRyaWVzLFxuICAgICAgICAgICAgc3ltbGlua0V4aXN0c1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRyaWVzIHRvIHJlYWQgdGhlIHZlcnNpb24gZnJvbSBvdXIgb3duIHBhY2thZ2UuanNvbi5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgZ2V0VmVyc2lvbigpIHtcbiAgICAgICAgaWYgKHRoaXMudmVyc2lvbikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudmVyc2lvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB2ZXJzaW9uID0gbnVsbDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICh7IHZlcnNpb24gfSA9IEpTT04ucGFyc2UoXG4gICAgICAgICAgICAgICAgZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICdwYWNrYWdlLmpzb24nKSwgJ1VURi04JylcbiAgICAgICAgICAgICkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgZXJyb3Igd2hpbGUgdHJ5aW5nIHRvIHJlYWQgJHtwYXRoLmpvaW4oX19kaXJuYW1lLCAncGFja2FnZS5qc29uJyl9YCwgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZlcnNpb247XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVHJpZXMgdG8gcmVhZCB0aGUgdmVyc2lvbiBmcm9tIG91ciBvd24gcGFja2FnZS5qc29uLlxuICAgICAqXG4gICAgICogQHJldHVybnMge3N0cmluZ31cbiAgICAgKi9cbiAgICBnZXRFbGVjdHJvblZlcnNpb24oKSB7XG4gICAgICAgIGxldCB2ZXJzaW9uID0gbnVsbDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHZlcnNpb24gPSBKU09OLnBhcnNlKFxuICAgICAgICAgICAgICAgIGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAncGFja2FnZS5qc29uJyksICdVVEYtOCcpXG4gICAgICAgICAgICApLmRlcGVuZGVuY2llcy5lbGVjdHJvbjtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZXJyb3IoYGVycm9yIHdoaWxlIHRyeWluZyB0byByZWFkICR7cGF0aC5qb2luKF9fZGlybmFtZSwgJ3BhY2thZ2UuanNvbicpfWAgK1xuICAgICAgICAgICAgICAgICdvciB0aGUgZWxlY3Ryb24gdmVyc2lvbiBmcm9tIGl0JywgZSk7XG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZlcnNpb247XG4gICAgfVxuXG5cbiAgICBpbml0KCkge1xuICAgICAgICB0aGlzLmRlc2t0b3Auc2NhZmZvbGQoKTtcbiAgICAgICAgdGhpcy5tZXRlb3JBcHAudXBkYXRlR2l0SWdub3JlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgYnVpbGRJbnN0YWxsZXIoKSB7XG4gICAgICAgIHRoaXMuZW52Lm9wdGlvbnMuaW5zdGFsbGVyQnVpbGQgPSB0cnVlO1xuICAgICAgICBhd2FpdCB0aGlzLmVsZWN0cm9uQXBwLmJ1aWxkKCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVsZWN0cm9uQnVpbGRlci5idWlsZCgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcignZXJyb3Igb2NjdXJyZWQgd2hpbGUgYnVpbGRpbmcgaW5zdGFsbGVyJywgZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBydW4oKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZWxlY3Ryb25BcHAuYnVpbGQodHJ1ZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgYnVpbGQoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZWxlY3Ryb25BcHAuYnVpbGQoKTtcbiAgICB9XG5cbiAgICBqdXN0UnVuKCkge1xuICAgICAgICB0aGlzLmVsZWN0cm9uLnJ1bigpO1xuICAgIH1cblxuICAgIGFzeW5jIHJ1blBhY2thZ2VyKCkge1xuICAgICAgICBhd2FpdCB0aGlzLmVsZWN0cm9uQXBwLmJ1aWxkKCk7XG5cbiAgICAgICAgdGhpcy5wYWNrYWdlci5wYWNrYWdlQXBwKCkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKGB3aGlsZSB0cnlpbmcgdG8gYnVpbGQgYSBwYWNrYWdlIGFuIGVycm9yIG9jY3VycmVkOiAke2V9YCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZXhwb3J0cyhpbnB1dCwgb3V0cHV0LCBvcHRpb25zLCB7IGxvZyA9IExvZ2dlciB9ID0geyBsb2c6IExvZ2dlciB9KSB7XG4gICAgcmV0dXJuIG5ldyBNZXRlb3JEZXNrdG9wKGlucHV0LCBvdXRwdXQsIG9wdGlvbnMsIHsgbG9nIH0pO1xufVxuIl19