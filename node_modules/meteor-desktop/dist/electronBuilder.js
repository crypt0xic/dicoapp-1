"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _electronBuilder = require("electron-builder");

var _yarn = require("electron-builder-lib/out/util/yarn");

var _packageDependencies = require("electron-builder-lib/out/util/packageDependencies");

var _shelljs = _interopRequireDefault(require("shelljs"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var _rimraf = _interopRequireDefault(require("rimraf"));

var _crossSpawn = _interopRequireDefault(require("cross-spawn"));

var _log = _interopRequireDefault(require("./log"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } } function _next(value) { step("next", value); } function _throw(err) { step("throw", err); } _next(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

/**
 * Promisfied rimraf.
 *
 * @param {string} dirPath - path to the dir to be deleted
 * @param {number} delay - delay the task by ms
 * @returns {Promise<any>}
 */
function removeDir(dirPath) {
  var delay = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;
  return new Promise(function (resolve, reject) {
    setTimeout(function () {
      (0, _rimraf.default)(dirPath, {
        maxBusyTries: 100
      }, function (err) {
        if (err) {
          reject(err);
        } else {
          resolve();
        }
      });
    }, delay);
  });
}
/**
 * Wrapper for electron-builder.
 */


var InstallerBuilder =
/*#__PURE__*/
function () {
  /**
   * @param {MeteorDesktop} $ - context
   *
   * @constructor
   */
  function InstallerBuilder($) {
    _classCallCheck(this, InstallerBuilder);

    this.log = new _log.default('electronBuilder');
    this.$ = $;
    this.firstPass = true;
    this.lastRebuild = {};
    this.currentContext = null;
    this.installerDir = _path.default.join(this.$.env.options.output, this.$.env.paths.installerDir);
  }
  /**
   * Prepares the last rebuild object for electron-builder.
   *
   * @param {string} arch
   * @param {string} platform
   * @returns {Object}
   */


  _createClass(InstallerBuilder, [{
    key: "prepareLastRebuildObject",
    value: function prepareLastRebuildObject(arch) {
      var platform = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : process.platform;
      var productionDeps = (0, _packageDependencies.createLazyProductionDeps)(this.$.env.paths.electronApp.root);
      this.lastRebuild = {
        frameworkInfo: {
          version: this.$.getElectronVersion(),
          useCustomDist: true
        },
        platform,
        arch,
        productionDeps
      };
      return this.lastRebuild;
    }
    /**
     * Calls npm rebuild from electron-builder.
     * @param {string} arch
     * @param {string} platform
     * @param {boolean} install
     * @returns {Promise}
     */

  }, {
    key: "installOrRebuild",
    value: function () {
      var _installOrRebuild2 = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee(arch) {
        var platform,
            install,
            _args = arguments;
        return regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                platform = _args.length > 1 && _args[1] !== undefined ? _args[1] : process.platform;
                install = _args.length > 2 && _args[2] !== undefined ? _args[2] : false;
                this.log.debug(`calling installOrRebuild from electron-builder for arch ${arch}`);
                this.prepareLastRebuildObject(arch, platform);
                _context.next = 6;
                return (0, _yarn.installOrRebuild)(this.$.desktop.getSettings().builderOptions || {}, this.$.env.paths.electronApp.root, this.lastRebuild, install);

              case 6:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      return function installOrRebuild(_x) {
        return _installOrRebuild2.apply(this, arguments);
      };
    }()
    /**
     * Callback invoked before build is made. Ensures that app.asar have the right rebuilt
     * node_modules.
     *
     * @param {Object} context
     * @returns {Promise}
     */

  }, {
    key: "beforeBuild",
    value: function beforeBuild(context) {
      var _this = this;

      this.currentContext = Object.assign({}, context);
      return new Promise(function (resolve, reject) {
        var platformMatches = process.platform === context.platform.nodeName;
        var rebuild = platformMatches && context.arch !== _this.lastRebuild.arch;

        if (!platformMatches) {
          _this.log.warn('skipping dependencies rebuild because platform is different, if you have native ' + 'node modules as your app dependencies you should od the build on the target platform only');
        }

        if (!rebuild) {
          _this.moveNodeModulesOut().catch(function (e) {
            return reject(e);
          }).then(function () {
            return setTimeout(function () {
              return resolve(false);
            }, 2000);
          }); // Timeout helps on Windows to clear the file locks.

        } else {
          // Lets rebuild the node_modules for different arch.
          _this.installOrRebuild(context.arch, context.platform.nodeName).catch(function (e) {
            return reject(e);
          }).then(function () {
            return _this.$.electronApp.installLocalNodeModules(context.arch);
          }).catch(function (e) {
            return reject(e);
          }).then(function () {
            _this.$.electronApp.scaffold.createAppRoot();

            _this.$.electronApp.scaffold.copySkeletonApp();

            return _this.$.electronApp.packSkeletonToAsar([_this.$.env.paths.electronApp.meteorAsar, _this.$.env.paths.electronApp.desktopAsar, _this.$.env.paths.electronApp.extracted]);
          }).catch(function (e) {
            return reject(e);
          }).then(function () {
            return _this.moveNodeModulesOut();
          }).catch(function (e) {
            return reject(e);
          }).then(function () {
            return resolve(false);
          });
        }
      });
    }
    /**
     * Callback to be invoked after packing. Restores node_modules to the .desktop-build.
     * @returns {Promise}
     */

  }, {
    key: "afterPack",
    value: function afterPack(context) {
      var _this2 = this;

      return new Promise(function (resolve, reject) {
        _shelljs.default.config.fatal = true;

        if (_this2.$.utils.exists(_this2.$.env.paths.electronApp.extractedNodeModules)) {
          _this2.log.debug('injecting extracted modules');

          _shelljs.default.cp('-Rf', _this2.$.env.paths.electronApp.extractedNodeModules, _path.default.join(_this2.getPackagedAppPath(context), 'node_modules'));
        }

        _this2.log.debug('moving node_modules back'); // Move node_modules back.


        try {
          _shelljs.default.mv(_this2.$.env.paths.electronApp.tmpNodeModules, _this2.$.env.paths.electronApp.nodeModules);
        } catch (e) {
          reject(e);
          return;
        } finally {
          _shelljs.default.config.reset();
        }

        if (_this2.firstPass) {
          _this2.firstPass = false;
        }

        _this2.log.debug('node_modules moved back');

        _this2.wait().catch(function (e) {
          return reject(e);
        }).then(function () {
          return resolve();
        });
      });
    }
    /**
     * This command kills orphaned MSBuild.exe processes.
     * Sometime after native node_modules compilation they are still writing some logs,
     * prevent node_modules from being deleted.
     */

  }, {
    key: "killMSBuild",
    value: function killMSBuild() {
      var _this3 = this;

      if (this.currentContext.platform.nodeName !== 'win32') {
        return;
      }

      try {
        var out = _crossSpawn.default.sync('wmic', ['process', 'where', 'caption="MSBuild.exe"', 'get', 'processid']).stdout.toString('utf-8').split('\n');

        var regex = new RegExp(/(\d+)/, 'gm'); // No we will check for those with the matching params.

        out.forEach(function (line) {
          var match = regex.exec(line) || false;

          if (match) {
            _this3.log.debug(`killing MSBuild.exe at pid: ${match[1]}`);

            _crossSpawn.default.sync('taskkill', ['/pid', match[1], '/f', '/t']);
          }

          regex.lastIndex = 0;
        });
      } catch (e) {
        this.log.debug('kill MSBuild failed');
      }
    }
    /**
     * Returns the path to packaged app.
     * @returns {string}
     */

  }, {
    key: "getPackagedAppPath",
    value: function getPackagedAppPath() {
      var context = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

      if (this.currentContext.platform.nodeName === 'darwin') {
        return _path.default.join(this.installerDir, `${context.packager.appInfo.productFilename}.app`, 'Contents', 'Resources', 'app');
      }

      var platformDir = `${this.currentContext.platform.nodeName === 'win32' ? 'win' : 'linux'}-${this.currentContext.arch === 'ia32' ? 'ia32-' : ''}unpacked`;
      return _path.default.join(this.installerDir, platformDir, 'resources', 'app');
    }
    /**
     * On Windows it waits for the app.asar in the packed app to be free (no file locks).
     * @returns {*}
     */

  }, {
    key: "wait",
    value: function wait() {
      if (this.currentContext.platform.nodeName !== 'win32') {
        return Promise.resolve();
      }

      var appAsarPath = _path.default.join(this.getPackagedAppPath(), 'app.asar');

      var retries = 0;
      var self = this;
      return new Promise(function (resolve, reject) {
        function check() {
          _fs.default.open(appAsarPath, 'r+', function (err, fd) {
            retries += 1;

            if (err) {
              if (err.code !== 'ENOENT') {
                self.log.debug(`waiting for app.asar to be readable, ${'code' in err ? `currently reading it returns ${err.code}` : ''}`);

                if (retries < 6) {
                  setTimeout(function () {
                    return check();
                  }, 4000);
                } else {
                  reject(`file is locked: ${appAsarPath}`);
                }
              } else {
                resolve();
              }
            } else {
              _fs.default.closeSync(fd);

              resolve();
            }
          });
        }

        check();
      });
    }
    /**
     * Prepares the target object passed to the electron-builder.
     *
     * @returns {Map<Platform, Map<Arch, Array<string>>>}
     */

  }, {
    key: "prepareTargets",
    value: function prepareTargets() {
      var arch = this.$.env.options.ia32 ? 'ia32' : 'x64';
      arch = this.$.env.options.allArchs ? 'all' : arch;
      var targets = [];

      if (this.$.env.options.win) {
        targets.push(_electronBuilder.Platform.WINDOWS);
      }

      if (this.$.env.options.linux) {
        targets.push(_electronBuilder.Platform.LINUX);
      }

      if (this.$.env.options.mac) {
        targets.push(_electronBuilder.Platform.MAC);
      }

      if (targets.length === 0) {
        if (this.$.env.os.isWindows) {
          targets.push(_electronBuilder.Platform.WINDOWS);
        } else if (this.$.env.os.isLinux) {
          targets.push(_electronBuilder.Platform.LINUX);
        } else {
          targets.push(_electronBuilder.Platform.MAC);
        }
      }

      return (0, _electronBuilder.createTargets)(targets, null, arch);
    }
  }, {
    key: "build",
    value: function () {
      var _build2 = _asyncToGenerator(
      /*#__PURE__*/
      regeneratorRuntime.mark(function _callee2() {
        var settings, builderOptions;
        return regeneratorRuntime.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                settings = this.$.desktop.getSettings();

                if (!('builderOptions' in settings)) {
                  this.log.error('no builderOptions in settings.json, aborting');
                  process.exit(1);
                }

                builderOptions = Object.assign({}, settings.builderOptions);
                builderOptions.asar = false;
                builderOptions.npmRebuild = true;
                builderOptions.beforeBuild = this.beforeBuild.bind(this);
                builderOptions.afterPack = this.afterPack.bind(this);
                builderOptions.electronVersion = this.$.getElectronVersion();
                builderOptions.directories = {
                  app: this.$.env.paths.electronApp.root,
                  output: _path.default.join(this.$.env.options.output, this.$.env.paths.installerDir)
                };
                _context2.prev = 9;
                this.log.debug('calling build from electron-builder');
                _context2.next = 13;
                return (0, _electronBuilder.build)(Object.assign({
                  targets: this.prepareTargets(),
                  config: builderOptions
                }, settings.builderCliOptions));

              case 13:
                if (this.$.utils.exists(this.$.env.paths.electronApp.extractedNodeModules)) {
                  _shelljs.default.rm('-rf', this.$.env.paths.electronApp.extractedNodeModules);
                }

                _context2.next = 19;
                break;

              case 16:
                _context2.prev = 16;
                _context2.t0 = _context2["catch"](9);
                this.log.error('error while building installer: ', _context2.t0);

              case 19:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this, [[9, 16]]);
      }));

      return function build() {
        return _build2.apply(this, arguments);
      };
    }()
    /**
     * Moves node_modules out of the app because while the app will be packaged
     * we do not want it to be there.
     * @returns {Promise<any>}
     */

  }, {
    key: "moveNodeModulesOut",
    value: function moveNodeModulesOut() {
      var _this4 = this;

      return new Promise(function (resolve, reject) {
        _this4.log.debug('moving node_modules out, because we have them already in' + ' app.asar');

        _this4.killMSBuild();

        removeDir(_this4.$.env.paths.electronApp.tmpNodeModules).catch(function (e) {
          return reject(e);
        }).then(function () {
          _shelljs.default.config.fatal = true;
          _shelljs.default.config.verbose = true;

          try {
            _shelljs.default.mv(_this4.$.env.paths.electronApp.nodeModules, _this4.$.env.paths.electronApp.tmpNodeModules);

            _shelljs.default.config.reset();

            return _this4.wait();
          } catch (e) {
            _shelljs.default.config.reset();

            return Promise.reject(e);
          }
        }).catch(function (e) {
          return reject(e);
        }).then(function () {
          return removeDir(_this4.$.env.paths.electronApp.nodeModules, 1000);
        }).catch(function (e) {
          return reject(e);
        }).then(function () {
          return _this4.wait();
        }).catch(reject).then(resolve);
      });
    }
  }]);

  return InstallerBuilder;
}();

exports.default = InstallerBuilder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9lbGVjdHJvbkJ1aWxkZXIuanMiXSwibmFtZXMiOlsicmVtb3ZlRGlyIiwiZGlyUGF0aCIsImRlbGF5IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzZXRUaW1lb3V0IiwibWF4QnVzeVRyaWVzIiwiZXJyIiwiSW5zdGFsbGVyQnVpbGRlciIsIiQiLCJsb2ciLCJmaXJzdFBhc3MiLCJsYXN0UmVidWlsZCIsImN1cnJlbnRDb250ZXh0IiwiaW5zdGFsbGVyRGlyIiwiam9pbiIsImVudiIsIm9wdGlvbnMiLCJvdXRwdXQiLCJwYXRocyIsImFyY2giLCJwbGF0Zm9ybSIsInByb2Nlc3MiLCJwcm9kdWN0aW9uRGVwcyIsImVsZWN0cm9uQXBwIiwicm9vdCIsImZyYW1ld29ya0luZm8iLCJ2ZXJzaW9uIiwiZ2V0RWxlY3Ryb25WZXJzaW9uIiwidXNlQ3VzdG9tRGlzdCIsImluc3RhbGwiLCJkZWJ1ZyIsInByZXBhcmVMYXN0UmVidWlsZE9iamVjdCIsImRlc2t0b3AiLCJnZXRTZXR0aW5ncyIsImJ1aWxkZXJPcHRpb25zIiwiY29udGV4dCIsIk9iamVjdCIsImFzc2lnbiIsInBsYXRmb3JtTWF0Y2hlcyIsIm5vZGVOYW1lIiwicmVidWlsZCIsIndhcm4iLCJtb3ZlTm9kZU1vZHVsZXNPdXQiLCJjYXRjaCIsImUiLCJ0aGVuIiwiaW5zdGFsbE9yUmVidWlsZCIsImluc3RhbGxMb2NhbE5vZGVNb2R1bGVzIiwic2NhZmZvbGQiLCJjcmVhdGVBcHBSb290IiwiY29weVNrZWxldG9uQXBwIiwicGFja1NrZWxldG9uVG9Bc2FyIiwibWV0ZW9yQXNhciIsImRlc2t0b3BBc2FyIiwiZXh0cmFjdGVkIiwiY29uZmlnIiwiZmF0YWwiLCJ1dGlscyIsImV4aXN0cyIsImV4dHJhY3RlZE5vZGVNb2R1bGVzIiwiY3AiLCJnZXRQYWNrYWdlZEFwcFBhdGgiLCJtdiIsInRtcE5vZGVNb2R1bGVzIiwibm9kZU1vZHVsZXMiLCJyZXNldCIsIndhaXQiLCJvdXQiLCJzeW5jIiwic3Rkb3V0IiwidG9TdHJpbmciLCJzcGxpdCIsInJlZ2V4IiwiUmVnRXhwIiwiZm9yRWFjaCIsImxpbmUiLCJtYXRjaCIsImV4ZWMiLCJsYXN0SW5kZXgiLCJwYWNrYWdlciIsImFwcEluZm8iLCJwcm9kdWN0RmlsZW5hbWUiLCJwbGF0Zm9ybURpciIsImFwcEFzYXJQYXRoIiwicmV0cmllcyIsInNlbGYiLCJjaGVjayIsIm9wZW4iLCJmZCIsImNvZGUiLCJjbG9zZVN5bmMiLCJpYTMyIiwiYWxsQXJjaHMiLCJ0YXJnZXRzIiwid2luIiwicHVzaCIsIldJTkRPV1MiLCJsaW51eCIsIkxJTlVYIiwibWFjIiwiTUFDIiwibGVuZ3RoIiwib3MiLCJpc1dpbmRvd3MiLCJpc0xpbnV4Iiwic2V0dGluZ3MiLCJlcnJvciIsImV4aXQiLCJhc2FyIiwibnBtUmVidWlsZCIsImJlZm9yZUJ1aWxkIiwiYmluZCIsImFmdGVyUGFjayIsImVsZWN0cm9uVmVyc2lvbiIsImRpcmVjdG9yaWVzIiwiYXBwIiwicHJlcGFyZVRhcmdldHMiLCJidWlsZGVyQ2xpT3B0aW9ucyIsInJtIiwia2lsbE1TQnVpbGQiLCJ2ZXJib3NlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7OztBQUVBOzs7Ozs7O0FBT0EsU0FBU0EsU0FBVCxDQUFtQkMsT0FBbkIsRUFBdUM7QUFBQSxNQUFYQyxLQUFXLHVFQUFILENBQUc7QUFDbkMsU0FBTyxJQUFJQyxPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQ3BDQyxlQUFXLFlBQU07QUFDYiwyQkFBT0wsT0FBUCxFQUFnQjtBQUNaTSxzQkFBYztBQURGLE9BQWhCLEVBRUcsVUFBQ0MsR0FBRCxFQUFTO0FBQ1IsWUFBSUEsR0FBSixFQUFTO0FBQ0xILGlCQUFPRyxHQUFQO0FBQ0gsU0FGRCxNQUVPO0FBQ0hKO0FBQ0g7QUFDSixPQVJEO0FBU0gsS0FWRCxFQVVHRixLQVZIO0FBV0gsR0FaTSxDQUFQO0FBYUg7QUFFRDs7Ozs7SUFHcUJPLGdCOzs7QUFDakI7Ozs7O0FBS0EsNEJBQVlDLENBQVosRUFBZTtBQUFBOztBQUNYLFNBQUtDLEdBQUwsR0FBVyxpQkFBUSxpQkFBUixDQUFYO0FBQ0EsU0FBS0QsQ0FBTCxHQUFTQSxDQUFUO0FBQ0EsU0FBS0UsU0FBTCxHQUFpQixJQUFqQjtBQUNBLFNBQUtDLFdBQUwsR0FBbUIsRUFBbkI7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLElBQXRCO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQixjQUFLQyxJQUFMLENBQVUsS0FBS04sQ0FBTCxDQUFPTyxHQUFQLENBQVdDLE9BQVgsQ0FBbUJDLE1BQTdCLEVBQXFDLEtBQUtULENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCTCxZQUF0RCxDQUFwQjtBQUNIO0FBRUQ7Ozs7Ozs7Ozs7OzZDQU95Qk0sSSxFQUFtQztBQUFBLFVBQTdCQyxRQUE2Qix1RUFBbEJDLFFBQVFELFFBQVU7QUFDeEQsVUFBTUUsaUJBQWlCLG1EQUF5QixLQUFLZCxDQUFMLENBQU9PLEdBQVAsQ0FBV0csS0FBWCxDQUFpQkssV0FBakIsQ0FBNkJDLElBQXRELENBQXZCO0FBQ0EsV0FBS2IsV0FBTCxHQUFtQjtBQUNmYyx1QkFBZTtBQUFFQyxtQkFBUyxLQUFLbEIsQ0FBTCxDQUFPbUIsa0JBQVAsRUFBWDtBQUF3Q0MseUJBQWU7QUFBdkQsU0FEQTtBQUVmUixnQkFGZTtBQUdmRCxZQUhlO0FBSWZHO0FBSmUsT0FBbkI7QUFNQSxhQUFPLEtBQUtYLFdBQVo7QUFDSDtBQUVEOzs7Ozs7Ozs7Ozs7OytDQU91QlEsSTs7Ozs7Ozs7QUFBTUMsd0IsMkRBQVdDLFFBQVFELFE7QUFBVVMsdUIsMkRBQVUsSztBQUNoRSxxQkFBS3BCLEdBQUwsQ0FBU3FCLEtBQVQsQ0FBZ0IsMkRBQTBEWCxJQUFLLEVBQS9FO0FBQ0EscUJBQUtZLHdCQUFMLENBQThCWixJQUE5QixFQUFvQ0MsUUFBcEM7O3VCQUNNLDRCQUFpQixLQUFLWixDQUFMLENBQU93QixPQUFQLENBQWVDLFdBQWYsR0FBNkJDLGNBQTdCLElBQStDLEVBQWhFLEVBQ0YsS0FBSzFCLENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2QkMsSUFEM0IsRUFDaUMsS0FBS2IsV0FEdEMsRUFDbURrQixPQURuRCxDOzs7Ozs7Ozs7Ozs7OztBQUlWOzs7Ozs7Ozs7O2dDQU9ZTSxPLEVBQVM7QUFBQTs7QUFDakIsV0FBS3ZCLGNBQUwsR0FBc0J3QixPQUFPQyxNQUFQLENBQWMsRUFBZCxFQUFrQkYsT0FBbEIsQ0FBdEI7QUFDQSxhQUFPLElBQUlsQyxPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQ3BDLFlBQU1tQyxrQkFBa0JqQixRQUFRRCxRQUFSLEtBQXFCZSxRQUFRZixRQUFSLENBQWlCbUIsUUFBOUQ7QUFDQSxZQUFNQyxVQUFVRixtQkFBbUJILFFBQVFoQixJQUFSLEtBQWlCLE1BQUtSLFdBQUwsQ0FBaUJRLElBQXJFOztBQUNBLFlBQUksQ0FBQ21CLGVBQUwsRUFBc0I7QUFDbEIsZ0JBQUs3QixHQUFMLENBQVNnQyxJQUFULENBQWMscUZBQ1YsMkZBREo7QUFFSDs7QUFFRCxZQUFJLENBQUNELE9BQUwsRUFBYztBQUNWLGdCQUFLRSxrQkFBTCxHQUNLQyxLQURMLENBQ1c7QUFBQSxtQkFBS3hDLE9BQU95QyxDQUFQLENBQUw7QUFBQSxXQURYLEVBRUtDLElBRkwsQ0FFVTtBQUFBLG1CQUFNekMsV0FBVztBQUFBLHFCQUFNRixRQUFRLEtBQVIsQ0FBTjtBQUFBLGFBQVgsRUFBaUMsSUFBakMsQ0FBTjtBQUFBLFdBRlYsRUFEVSxDQUlWOztBQUNILFNBTEQsTUFLTztBQUNIO0FBQ0EsZ0JBQUs0QyxnQkFBTCxDQUFzQlgsUUFBUWhCLElBQTlCLEVBQW9DZ0IsUUFBUWYsUUFBUixDQUFpQm1CLFFBQXJELEVBQ0tJLEtBREwsQ0FDVztBQUFBLG1CQUFLeEMsT0FBT3lDLENBQVAsQ0FBTDtBQUFBLFdBRFgsRUFFS0MsSUFGTCxDQUVVO0FBQUEsbUJBQU0sTUFBS3JDLENBQUwsQ0FBT2UsV0FBUCxDQUFtQndCLHVCQUFuQixDQUEyQ1osUUFBUWhCLElBQW5ELENBQU47QUFBQSxXQUZWLEVBR0t3QixLQUhMLENBR1c7QUFBQSxtQkFBS3hDLE9BQU95QyxDQUFQLENBQUw7QUFBQSxXQUhYLEVBSUtDLElBSkwsQ0FJVSxZQUFNO0FBQ1Isa0JBQUtyQyxDQUFMLENBQU9lLFdBQVAsQ0FBbUJ5QixRQUFuQixDQUE0QkMsYUFBNUI7O0FBQ0Esa0JBQUt6QyxDQUFMLENBQU9lLFdBQVAsQ0FBbUJ5QixRQUFuQixDQUE0QkUsZUFBNUI7O0FBQ0EsbUJBQU8sTUFBSzFDLENBQUwsQ0FBT2UsV0FBUCxDQUFtQjRCLGtCQUFuQixDQUNILENBQ0ksTUFBSzNDLENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2QjZCLFVBRGpDLEVBRUksTUFBSzVDLENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2QjhCLFdBRmpDLEVBR0ksTUFBSzdDLENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2QitCLFNBSGpDLENBREcsQ0FBUDtBQU9ILFdBZEwsRUFlS1gsS0FmTCxDQWVXO0FBQUEsbUJBQUt4QyxPQUFPeUMsQ0FBUCxDQUFMO0FBQUEsV0FmWCxFQWdCS0MsSUFoQkwsQ0FnQlU7QUFBQSxtQkFBTSxNQUFLSCxrQkFBTCxFQUFOO0FBQUEsV0FoQlYsRUFpQktDLEtBakJMLENBaUJXO0FBQUEsbUJBQUt4QyxPQUFPeUMsQ0FBUCxDQUFMO0FBQUEsV0FqQlgsRUFrQktDLElBbEJMLENBa0JVO0FBQUEsbUJBQU0zQyxRQUFRLEtBQVIsQ0FBTjtBQUFBLFdBbEJWO0FBbUJIO0FBQ0osT0FuQ00sQ0FBUDtBQW9DSDtBQUVEOzs7Ozs7OzhCQUlVaUMsTyxFQUFTO0FBQUE7O0FBQ2YsYUFBTyxJQUFJbEMsT0FBSixDQUFZLFVBQUNDLE9BQUQsRUFBVUMsTUFBVixFQUFxQjtBQUNwQyx5QkFBTW9ELE1BQU4sQ0FBYUMsS0FBYixHQUFxQixJQUFyQjs7QUFFQSxZQUFJLE9BQUtoRCxDQUFMLENBQU9pRCxLQUFQLENBQWFDLE1BQWIsQ0FBb0IsT0FBS2xELENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2Qm9DLG9CQUFqRCxDQUFKLEVBQTRFO0FBQ3hFLGlCQUFLbEQsR0FBTCxDQUFTcUIsS0FBVCxDQUFlLDZCQUFmOztBQUNBLDJCQUFNOEIsRUFBTixDQUNJLEtBREosRUFFSSxPQUFLcEQsQ0FBTCxDQUFPTyxHQUFQLENBQVdHLEtBQVgsQ0FBaUJLLFdBQWpCLENBQTZCb0Msb0JBRmpDLEVBR0ksY0FBSzdDLElBQUwsQ0FBVSxPQUFLK0Msa0JBQUwsQ0FBd0IxQixPQUF4QixDQUFWLEVBQTRDLGNBQTVDLENBSEo7QUFLSDs7QUFFRCxlQUFLMUIsR0FBTCxDQUFTcUIsS0FBVCxDQUFlLDBCQUFmLEVBWm9DLENBYXBDOzs7QUFFQSxZQUFJO0FBQ0EsMkJBQU1nQyxFQUFOLENBQ0ksT0FBS3RELENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2QndDLGNBRGpDLEVBRUksT0FBS3ZELENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2QnlDLFdBRmpDO0FBSUgsU0FMRCxDQUtFLE9BQU9wQixDQUFQLEVBQVU7QUFDUnpDLGlCQUFPeUMsQ0FBUDtBQUNBO0FBQ0gsU0FSRCxTQVFVO0FBQ04sMkJBQU1XLE1BQU4sQ0FBYVUsS0FBYjtBQUNIOztBQUVELFlBQUksT0FBS3ZELFNBQVQsRUFBb0I7QUFDaEIsaUJBQUtBLFNBQUwsR0FBaUIsS0FBakI7QUFDSDs7QUFDRCxlQUFLRCxHQUFMLENBQVNxQixLQUFULENBQWUseUJBQWY7O0FBRUEsZUFBS29DLElBQUwsR0FDS3ZCLEtBREwsQ0FDVztBQUFBLGlCQUFLeEMsT0FBT3lDLENBQVAsQ0FBTDtBQUFBLFNBRFgsRUFFS0MsSUFGTCxDQUVVO0FBQUEsaUJBQU0zQyxTQUFOO0FBQUEsU0FGVjtBQUdILE9BbkNNLENBQVA7QUFvQ0g7QUFFRDs7Ozs7Ozs7a0NBS2M7QUFBQTs7QUFDVixVQUFJLEtBQUtVLGNBQUwsQ0FBb0JRLFFBQXBCLENBQTZCbUIsUUFBN0IsS0FBMEMsT0FBOUMsRUFBdUQ7QUFDbkQ7QUFDSDs7QUFDRCxVQUFJO0FBQ0EsWUFBTTRCLE1BQU0sb0JBQ1BDLElBRE8sQ0FFSixNQUZJLEVBR0osQ0FBQyxTQUFELEVBQVksT0FBWixFQUFxQix1QkFBckIsRUFBOEMsS0FBOUMsRUFBcUQsV0FBckQsQ0FISSxFQUtQQyxNQUxPLENBS0FDLFFBTEEsQ0FLUyxPQUxULEVBTVBDLEtBTk8sQ0FNRCxJQU5DLENBQVo7O0FBUUEsWUFBTUMsUUFBUSxJQUFJQyxNQUFKLENBQVcsT0FBWCxFQUFvQixJQUFwQixDQUFkLENBVEEsQ0FVQTs7QUFDQU4sWUFBSU8sT0FBSixDQUFZLFVBQUNDLElBQUQsRUFBVTtBQUNsQixjQUFNQyxRQUFRSixNQUFNSyxJQUFOLENBQVdGLElBQVgsS0FBb0IsS0FBbEM7O0FBQ0EsY0FBSUMsS0FBSixFQUFXO0FBQ1AsbUJBQUtuRSxHQUFMLENBQVNxQixLQUFULENBQWdCLCtCQUE4QjhDLE1BQU0sQ0FBTixDQUFTLEVBQXZEOztBQUNBLGdDQUFNUixJQUFOLENBQVcsVUFBWCxFQUF1QixDQUFDLE1BQUQsRUFBU1EsTUFBTSxDQUFOLENBQVQsRUFBbUIsSUFBbkIsRUFBeUIsSUFBekIsQ0FBdkI7QUFDSDs7QUFDREosZ0JBQU1NLFNBQU4sR0FBa0IsQ0FBbEI7QUFDSCxTQVBEO0FBUUgsT0FuQkQsQ0FtQkUsT0FBT2xDLENBQVAsRUFBVTtBQUNSLGFBQUtuQyxHQUFMLENBQVNxQixLQUFULENBQWUscUJBQWY7QUFDSDtBQUNKO0FBRUQ7Ozs7Ozs7eUNBSWlDO0FBQUEsVUFBZEssT0FBYyx1RUFBSixFQUFJOztBQUM3QixVQUFJLEtBQUt2QixjQUFMLENBQW9CUSxRQUFwQixDQUE2Qm1CLFFBQTdCLEtBQTBDLFFBQTlDLEVBQXdEO0FBQ3BELGVBQU8sY0FBS3pCLElBQUwsQ0FDSCxLQUFLRCxZQURGLEVBRUYsR0FBRXNCLFFBQVE0QyxRQUFSLENBQWlCQyxPQUFqQixDQUF5QkMsZUFBZ0IsTUFGekMsRUFHSCxVQUhHLEVBR1MsV0FIVCxFQUdzQixLQUh0QixDQUFQO0FBS0g7O0FBQ0QsVUFBTUMsY0FDRCxHQUFFLEtBQUt0RSxjQUFMLENBQW9CUSxRQUFwQixDQUE2Qm1CLFFBQTdCLEtBQTBDLE9BQTFDLEdBQW9ELEtBQXBELEdBQTRELE9BQVEsSUFBRyxLQUFLM0IsY0FBTCxDQUFvQk8sSUFBcEIsS0FBNkIsTUFBN0IsR0FBc0MsT0FBdEMsR0FBZ0QsRUFBRyxVQURqSTtBQUVBLGFBQU8sY0FBS0wsSUFBTCxDQUNILEtBQUtELFlBREYsRUFFSHFFLFdBRkcsRUFHSCxXQUhHLEVBR1UsS0FIVixDQUFQO0FBS0g7QUFFRDs7Ozs7OzsyQkFJTztBQUNILFVBQUksS0FBS3RFLGNBQUwsQ0FBb0JRLFFBQXBCLENBQTZCbUIsUUFBN0IsS0FBMEMsT0FBOUMsRUFBdUQ7QUFDbkQsZUFBT3RDLFFBQVFDLE9BQVIsRUFBUDtBQUNIOztBQUNELFVBQU1pRixjQUFjLGNBQUtyRSxJQUFMLENBQ2hCLEtBQUsrQyxrQkFBTCxFQURnQixFQUVoQixVQUZnQixDQUFwQjs7QUFJQSxVQUFJdUIsVUFBVSxDQUFkO0FBQ0EsVUFBTUMsT0FBTyxJQUFiO0FBQ0EsYUFBTyxJQUFJcEYsT0FBSixDQUFZLFVBQUNDLE9BQUQsRUFBVUMsTUFBVixFQUFxQjtBQUNwQyxpQkFBU21GLEtBQVQsR0FBaUI7QUFDYixzQkFBR0MsSUFBSCxDQUFRSixXQUFSLEVBQXFCLElBQXJCLEVBQTJCLFVBQUM3RSxHQUFELEVBQU1rRixFQUFOLEVBQWE7QUFDcENKLHVCQUFXLENBQVg7O0FBQ0EsZ0JBQUk5RSxHQUFKLEVBQVM7QUFDTCxrQkFBSUEsSUFBSW1GLElBQUosS0FBYSxRQUFqQixFQUEyQjtBQUN2QkoscUJBQUs1RSxHQUFMLENBQVNxQixLQUFULENBQWdCLHdDQUF1QyxVQUFVeEIsR0FBVixHQUFpQixnQ0FBK0JBLElBQUltRixJQUFLLEVBQXpELEdBQTZELEVBQUcsRUFBdkg7O0FBQ0Esb0JBQUlMLFVBQVUsQ0FBZCxFQUFpQjtBQUNiaEYsNkJBQVc7QUFBQSwyQkFBTWtGLE9BQU47QUFBQSxtQkFBWCxFQUEwQixJQUExQjtBQUNILGlCQUZELE1BRU87QUFDSG5GLHlCQUFRLG1CQUFrQmdGLFdBQVksRUFBdEM7QUFDSDtBQUNKLGVBUEQsTUFPTztBQUNIakY7QUFDSDtBQUNKLGFBWEQsTUFXTztBQUNILDBCQUFHd0YsU0FBSCxDQUFhRixFQUFiOztBQUNBdEY7QUFDSDtBQUNKLFdBakJEO0FBa0JIOztBQUNEb0Y7QUFDSCxPQXRCTSxDQUFQO0FBdUJIO0FBRUQ7Ozs7Ozs7O3FDQUtpQjtBQUNiLFVBQUluRSxPQUFPLEtBQUtYLENBQUwsQ0FBT08sR0FBUCxDQUFXQyxPQUFYLENBQW1CMkUsSUFBbkIsR0FBMEIsTUFBMUIsR0FBbUMsS0FBOUM7QUFDQXhFLGFBQU8sS0FBS1gsQ0FBTCxDQUFPTyxHQUFQLENBQVdDLE9BQVgsQ0FBbUI0RSxRQUFuQixHQUE4QixLQUE5QixHQUFzQ3pFLElBQTdDO0FBRUEsVUFBTTBFLFVBQVUsRUFBaEI7O0FBRUEsVUFBSSxLQUFLckYsQ0FBTCxDQUFPTyxHQUFQLENBQVdDLE9BQVgsQ0FBbUI4RSxHQUF2QixFQUE0QjtBQUN4QkQsZ0JBQVFFLElBQVIsQ0FBYSwwQkFBU0MsT0FBdEI7QUFDSDs7QUFDRCxVQUFJLEtBQUt4RixDQUFMLENBQU9PLEdBQVAsQ0FBV0MsT0FBWCxDQUFtQmlGLEtBQXZCLEVBQThCO0FBQzFCSixnQkFBUUUsSUFBUixDQUFhLDBCQUFTRyxLQUF0QjtBQUNIOztBQUNELFVBQUksS0FBSzFGLENBQUwsQ0FBT08sR0FBUCxDQUFXQyxPQUFYLENBQW1CbUYsR0FBdkIsRUFBNEI7QUFDeEJOLGdCQUFRRSxJQUFSLENBQWEsMEJBQVNLLEdBQXRCO0FBQ0g7O0FBRUQsVUFBSVAsUUFBUVEsTUFBUixLQUFtQixDQUF2QixFQUEwQjtBQUN0QixZQUFJLEtBQUs3RixDQUFMLENBQU9PLEdBQVAsQ0FBV3VGLEVBQVgsQ0FBY0MsU0FBbEIsRUFBNkI7QUFDekJWLGtCQUFRRSxJQUFSLENBQWEsMEJBQVNDLE9BQXRCO0FBQ0gsU0FGRCxNQUVPLElBQUksS0FBS3hGLENBQUwsQ0FBT08sR0FBUCxDQUFXdUYsRUFBWCxDQUFjRSxPQUFsQixFQUEyQjtBQUM5Qlgsa0JBQVFFLElBQVIsQ0FBYSwwQkFBU0csS0FBdEI7QUFDSCxTQUZNLE1BRUE7QUFDSEwsa0JBQVFFLElBQVIsQ0FBYSwwQkFBU0ssR0FBdEI7QUFDSDtBQUNKOztBQUNELGFBQU8sb0NBQWNQLE9BQWQsRUFBdUIsSUFBdkIsRUFBNkIxRSxJQUE3QixDQUFQO0FBQ0g7Ozs7Ozs7Ozs7OztBQUdTc0Ysd0IsR0FBVyxLQUFLakcsQ0FBTCxDQUFPd0IsT0FBUCxDQUFlQyxXQUFmLEU7O0FBQ2pCLG9CQUFJLEVBQUUsb0JBQW9Cd0UsUUFBdEIsQ0FBSixFQUFxQztBQUNqQyx1QkFBS2hHLEdBQUwsQ0FBU2lHLEtBQVQsQ0FDSSw4Q0FESjtBQUdBckYsMEJBQVFzRixJQUFSLENBQWEsQ0FBYjtBQUNIOztBQUVLekUsOEIsR0FBaUJFLE9BQU9DLE1BQVAsQ0FBYyxFQUFkLEVBQWtCb0UsU0FBU3ZFLGNBQTNCLEM7QUFFdkJBLCtCQUFlMEUsSUFBZixHQUFzQixLQUF0QjtBQUNBMUUsK0JBQWUyRSxVQUFmLEdBQTRCLElBQTVCO0FBRUEzRSwrQkFBZTRFLFdBQWYsR0FBNkIsS0FBS0EsV0FBTCxDQUFpQkMsSUFBakIsQ0FBc0IsSUFBdEIsQ0FBN0I7QUFDQTdFLCtCQUFlOEUsU0FBZixHQUEyQixLQUFLQSxTQUFMLENBQWVELElBQWYsQ0FBb0IsSUFBcEIsQ0FBM0I7QUFDQTdFLCtCQUFlK0UsZUFBZixHQUFpQyxLQUFLekcsQ0FBTCxDQUFPbUIsa0JBQVAsRUFBakM7QUFFQU8sK0JBQWVnRixXQUFmLEdBQTZCO0FBQ3pCQyx1QkFBSyxLQUFLM0csQ0FBTCxDQUFPTyxHQUFQLENBQVdHLEtBQVgsQ0FBaUJLLFdBQWpCLENBQTZCQyxJQURUO0FBRXpCUCwwQkFBUSxjQUFLSCxJQUFMLENBQVUsS0FBS04sQ0FBTCxDQUFPTyxHQUFQLENBQVdDLE9BQVgsQ0FBbUJDLE1BQTdCLEVBQXFDLEtBQUtULENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCTCxZQUF0RDtBQUZpQixpQkFBN0I7O0FBTUkscUJBQUtKLEdBQUwsQ0FBU3FCLEtBQVQsQ0FBZSxxQ0FBZjs7dUJBQ00sNEJBQU1NLE9BQU9DLE1BQVAsQ0FBYztBQUN0QndELDJCQUFTLEtBQUt1QixjQUFMLEVBRGE7QUFFdEI3RCwwQkFBUXJCO0FBRmMsaUJBQWQsRUFHVHVFLFNBQVNZLGlCQUhBLENBQU4sQzs7O0FBS04sb0JBQUksS0FBSzdHLENBQUwsQ0FBT2lELEtBQVAsQ0FBYUMsTUFBYixDQUFvQixLQUFLbEQsQ0FBTCxDQUFPTyxHQUFQLENBQVdHLEtBQVgsQ0FBaUJLLFdBQWpCLENBQTZCb0Msb0JBQWpELENBQUosRUFBNEU7QUFDeEUsbUNBQU0yRCxFQUFOLENBQVMsS0FBVCxFQUFnQixLQUFLOUcsQ0FBTCxDQUFPTyxHQUFQLENBQVdHLEtBQVgsQ0FBaUJLLFdBQWpCLENBQTZCb0Msb0JBQTdDO0FBQ0g7Ozs7Ozs7O0FBRUQscUJBQUtsRCxHQUFMLENBQVNpRyxLQUFULENBQWUsa0NBQWY7Ozs7Ozs7Ozs7Ozs7O0FBSVI7Ozs7Ozs7O3lDQUtxQjtBQUFBOztBQUNqQixhQUFPLElBQUl6RyxPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQXFCO0FBQ3BDLGVBQUtNLEdBQUwsQ0FBU3FCLEtBQVQsQ0FBZSw2REFDWCxXQURKOztBQUVBLGVBQUt5RixXQUFMOztBQUNBekgsa0JBQVUsT0FBS1UsQ0FBTCxDQUFPTyxHQUFQLENBQVdHLEtBQVgsQ0FBaUJLLFdBQWpCLENBQTZCd0MsY0FBdkMsRUFDS3BCLEtBREwsQ0FDVztBQUFBLGlCQUFLeEMsT0FBT3lDLENBQVAsQ0FBTDtBQUFBLFNBRFgsRUFFS0MsSUFGTCxDQUVVLFlBQU07QUFDUiwyQkFBTVUsTUFBTixDQUFhQyxLQUFiLEdBQXFCLElBQXJCO0FBQ0EsMkJBQU1ELE1BQU4sQ0FBYWlFLE9BQWIsR0FBdUIsSUFBdkI7O0FBQ0EsY0FBSTtBQUNBLDZCQUFNMUQsRUFBTixDQUNJLE9BQUt0RCxDQUFMLENBQU9PLEdBQVAsQ0FBV0csS0FBWCxDQUFpQkssV0FBakIsQ0FBNkJ5QyxXQURqQyxFQUVJLE9BQUt4RCxDQUFMLENBQU9PLEdBQVAsQ0FBV0csS0FBWCxDQUFpQkssV0FBakIsQ0FBNkJ3QyxjQUZqQzs7QUFJQSw2QkFBTVIsTUFBTixDQUFhVSxLQUFiOztBQUNBLG1CQUFPLE9BQUtDLElBQUwsRUFBUDtBQUNILFdBUEQsQ0FPRSxPQUFPdEIsQ0FBUCxFQUFVO0FBQ1IsNkJBQU1XLE1BQU4sQ0FBYVUsS0FBYjs7QUFDQSxtQkFBT2hFLFFBQVFFLE1BQVIsQ0FBZXlDLENBQWYsQ0FBUDtBQUNIO0FBQ0osU0FoQkwsRUFpQktELEtBakJMLENBaUJXO0FBQUEsaUJBQUt4QyxPQUFPeUMsQ0FBUCxDQUFMO0FBQUEsU0FqQlgsRUFrQktDLElBbEJMLENBa0JVO0FBQUEsaUJBQU0vQyxVQUFVLE9BQUtVLENBQUwsQ0FBT08sR0FBUCxDQUFXRyxLQUFYLENBQWlCSyxXQUFqQixDQUE2QnlDLFdBQXZDLEVBQW9ELElBQXBELENBQU47QUFBQSxTQWxCVixFQW1CS3JCLEtBbkJMLENBbUJXO0FBQUEsaUJBQUt4QyxPQUFPeUMsQ0FBUCxDQUFMO0FBQUEsU0FuQlgsRUFvQktDLElBcEJMLENBb0JVO0FBQUEsaUJBQU0sT0FBS3FCLElBQUwsRUFBTjtBQUFBLFNBcEJWLEVBcUJLdkIsS0FyQkwsQ0FxQld4QyxNQXJCWCxFQXNCSzBDLElBdEJMLENBc0JVM0MsT0F0QlY7QUF1QkgsT0EzQk0sQ0FBUDtBQTRCSCIsImZpbGUiOiJlbGVjdHJvbkJ1aWxkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBidWlsZCwgUGxhdGZvcm0sIGNyZWF0ZVRhcmdldHMgfSBmcm9tICdlbGVjdHJvbi1idWlsZGVyJztcbmltcG9ydCB7IGluc3RhbGxPclJlYnVpbGQgfSBmcm9tICdlbGVjdHJvbi1idWlsZGVyLWxpYi9vdXQvdXRpbC95YXJuJztcbmltcG9ydCB7IGNyZWF0ZUxhenlQcm9kdWN0aW9uRGVwcyB9IGZyb20gJ2VsZWN0cm9uLWJ1aWxkZXItbGliL291dC91dGlsL3BhY2thZ2VEZXBlbmRlbmNpZXMnO1xuaW1wb3J0IHNoZWxsIGZyb20gJ3NoZWxsanMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHJpbXJhZiBmcm9tICdyaW1yYWYnO1xuaW1wb3J0IHNwYXduIGZyb20gJ2Nyb3NzLXNwYXduJztcbmltcG9ydCBMb2cgZnJvbSAnLi9sb2cnO1xuXG4vKipcbiAqIFByb21pc2ZpZWQgcmltcmFmLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBkaXJQYXRoIC0gcGF0aCB0byB0aGUgZGlyIHRvIGJlIGRlbGV0ZWRcbiAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIGRlbGF5IHRoZSB0YXNrIGJ5IG1zXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxhbnk+fVxuICovXG5mdW5jdGlvbiByZW1vdmVEaXIoZGlyUGF0aCwgZGVsYXkgPSAwKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICByaW1yYWYoZGlyUGF0aCwge1xuICAgICAgICAgICAgICAgIG1heEJ1c3lUcmllczogMTAwXG4gICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sIGRlbGF5KTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBXcmFwcGVyIGZvciBlbGVjdHJvbi1idWlsZGVyLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbnN0YWxsZXJCdWlsZGVyIHtcbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge01ldGVvckRlc2t0b3B9ICQgLSBjb250ZXh0XG4gICAgICpcbiAgICAgKiBAY29uc3RydWN0b3JcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcigkKSB7XG4gICAgICAgIHRoaXMubG9nID0gbmV3IExvZygnZWxlY3Ryb25CdWlsZGVyJyk7XG4gICAgICAgIHRoaXMuJCA9ICQ7XG4gICAgICAgIHRoaXMuZmlyc3RQYXNzID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5sYXN0UmVidWlsZCA9IHt9O1xuICAgICAgICB0aGlzLmN1cnJlbnRDb250ZXh0ID0gbnVsbDtcbiAgICAgICAgdGhpcy5pbnN0YWxsZXJEaXIgPSBwYXRoLmpvaW4odGhpcy4kLmVudi5vcHRpb25zLm91dHB1dCwgdGhpcy4kLmVudi5wYXRocy5pbnN0YWxsZXJEaXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFByZXBhcmVzIHRoZSBsYXN0IHJlYnVpbGQgb2JqZWN0IGZvciBlbGVjdHJvbi1idWlsZGVyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGFyY2hcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1cbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgICAqL1xuICAgIHByZXBhcmVMYXN0UmVidWlsZE9iamVjdChhcmNoLCBwbGF0Zm9ybSA9IHByb2Nlc3MucGxhdGZvcm0pIHtcbiAgICAgICAgY29uc3QgcHJvZHVjdGlvbkRlcHMgPSBjcmVhdGVMYXp5UHJvZHVjdGlvbkRlcHModGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5yb290KTtcbiAgICAgICAgdGhpcy5sYXN0UmVidWlsZCA9IHtcbiAgICAgICAgICAgIGZyYW1ld29ya0luZm86IHsgdmVyc2lvbjogdGhpcy4kLmdldEVsZWN0cm9uVmVyc2lvbigpLCB1c2VDdXN0b21EaXN0OiB0cnVlIH0sXG4gICAgICAgICAgICBwbGF0Zm9ybSxcbiAgICAgICAgICAgIGFyY2gsXG4gICAgICAgICAgICBwcm9kdWN0aW9uRGVwc1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdGhpcy5sYXN0UmVidWlsZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxscyBucG0gcmVidWlsZCBmcm9tIGVsZWN0cm9uLWJ1aWxkZXIuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGFyY2hcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGluc3RhbGxcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBhc3luYyBpbnN0YWxsT3JSZWJ1aWxkKGFyY2gsIHBsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybSwgaW5zdGFsbCA9IGZhbHNlKSB7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKGBjYWxsaW5nIGluc3RhbGxPclJlYnVpbGQgZnJvbSBlbGVjdHJvbi1idWlsZGVyIGZvciBhcmNoICR7YXJjaH1gKTtcbiAgICAgICAgdGhpcy5wcmVwYXJlTGFzdFJlYnVpbGRPYmplY3QoYXJjaCwgcGxhdGZvcm0pO1xuICAgICAgICBhd2FpdCBpbnN0YWxsT3JSZWJ1aWxkKHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCkuYnVpbGRlck9wdGlvbnMgfHwge30sXG4gICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnJvb3QsIHRoaXMubGFzdFJlYnVpbGQsIGluc3RhbGwpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGludm9rZWQgYmVmb3JlIGJ1aWxkIGlzIG1hZGUuIEVuc3VyZXMgdGhhdCBhcHAuYXNhciBoYXZlIHRoZSByaWdodCByZWJ1aWx0XG4gICAgICogbm9kZV9tb2R1bGVzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHRcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBiZWZvcmVCdWlsZChjb250ZXh0KSB7XG4gICAgICAgIHRoaXMuY3VycmVudENvbnRleHQgPSBPYmplY3QuYXNzaWduKHt9LCBjb250ZXh0KTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBsYXRmb3JtTWF0Y2hlcyA9IHByb2Nlc3MucGxhdGZvcm0gPT09IGNvbnRleHQucGxhdGZvcm0ubm9kZU5hbWU7XG4gICAgICAgICAgICBjb25zdCByZWJ1aWxkID0gcGxhdGZvcm1NYXRjaGVzICYmIGNvbnRleHQuYXJjaCAhPT0gdGhpcy5sYXN0UmVidWlsZC5hcmNoO1xuICAgICAgICAgICAgaWYgKCFwbGF0Zm9ybU1hdGNoZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZy53YXJuKCdza2lwcGluZyBkZXBlbmRlbmNpZXMgcmVidWlsZCBiZWNhdXNlIHBsYXRmb3JtIGlzIGRpZmZlcmVudCwgaWYgeW91IGhhdmUgbmF0aXZlICcgK1xuICAgICAgICAgICAgICAgICAgICAnbm9kZSBtb2R1bGVzIGFzIHlvdXIgYXBwIGRlcGVuZGVuY2llcyB5b3Ugc2hvdWxkIG9kIHRoZSBidWlsZCBvbiB0aGUgdGFyZ2V0IHBsYXRmb3JtIG9ubHknKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFyZWJ1aWxkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tb3ZlTm9kZU1vZHVsZXNPdXQoKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZSA9PiByZWplY3QoZSkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHNldFRpbWVvdXQoKCkgPT4gcmVzb2x2ZShmYWxzZSksIDIwMDApKTtcbiAgICAgICAgICAgICAgICAvLyBUaW1lb3V0IGhlbHBzIG9uIFdpbmRvd3MgdG8gY2xlYXIgdGhlIGZpbGUgbG9ja3MuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIExldHMgcmVidWlsZCB0aGUgbm9kZV9tb2R1bGVzIGZvciBkaWZmZXJlbnQgYXJjaC5cbiAgICAgICAgICAgICAgICB0aGlzLmluc3RhbGxPclJlYnVpbGQoY29udGV4dC5hcmNoLCBjb250ZXh0LnBsYXRmb3JtLm5vZGVOYW1lKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZSA9PiByZWplY3QoZSkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuJC5lbGVjdHJvbkFwcC5pbnN0YWxsTG9jYWxOb2RlTW9kdWxlcyhjb250ZXh0LmFyY2gpKVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZSA9PiByZWplY3QoZSkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJC5lbGVjdHJvbkFwcC5zY2FmZm9sZC5jcmVhdGVBcHBSb290KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZWxlY3Ryb25BcHAuc2NhZmZvbGQuY29weVNrZWxldG9uQXBwKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kLmVsZWN0cm9uQXBwLnBhY2tTa2VsZXRvblRvQXNhcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAubWV0ZW9yQXNhcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5kZXNrdG9wQXNhcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5leHRyYWN0ZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZSA9PiByZWplY3QoZSkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMubW92ZU5vZGVNb2R1bGVzT3V0KCkpXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaChlID0+IHJlamVjdChlKSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gcmVzb2x2ZShmYWxzZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayB0byBiZSBpbnZva2VkIGFmdGVyIHBhY2tpbmcuIFJlc3RvcmVzIG5vZGVfbW9kdWxlcyB0byB0aGUgLmRlc2t0b3AtYnVpbGQuXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICovXG4gICAgYWZ0ZXJQYWNrKGNvbnRleHQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHNoZWxsLmNvbmZpZy5mYXRhbCA9IHRydWU7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLiQudXRpbHMuZXhpc3RzKHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAuZXh0cmFjdGVkTm9kZU1vZHVsZXMpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ2luamVjdGluZyBleHRyYWN0ZWQgbW9kdWxlcycpO1xuICAgICAgICAgICAgICAgIHNoZWxsLmNwKFxuICAgICAgICAgICAgICAgICAgICAnLVJmJyxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5leHRyYWN0ZWROb2RlTW9kdWxlcyxcbiAgICAgICAgICAgICAgICAgICAgcGF0aC5qb2luKHRoaXMuZ2V0UGFja2FnZWRBcHBQYXRoKGNvbnRleHQpLCAnbm9kZV9tb2R1bGVzJylcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnbW92aW5nIG5vZGVfbW9kdWxlcyBiYWNrJyk7XG4gICAgICAgICAgICAvLyBNb3ZlIG5vZGVfbW9kdWxlcyBiYWNrLlxuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHNoZWxsLm12KFxuICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnRtcE5vZGVNb2R1bGVzLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLm5vZGVNb2R1bGVzXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICBzaGVsbC5jb25maWcucmVzZXQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuZmlyc3RQYXNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5maXJzdFBhc3MgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdub2RlX21vZHVsZXMgbW92ZWQgYmFjaycpO1xuXG4gICAgICAgICAgICB0aGlzLndhaXQoKVxuICAgICAgICAgICAgICAgIC5jYXRjaChlID0+IHJlamVjdChlKSlcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiByZXNvbHZlKCkpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGNvbW1hbmQga2lsbHMgb3JwaGFuZWQgTVNCdWlsZC5leGUgcHJvY2Vzc2VzLlxuICAgICAqIFNvbWV0aW1lIGFmdGVyIG5hdGl2ZSBub2RlX21vZHVsZXMgY29tcGlsYXRpb24gdGhleSBhcmUgc3RpbGwgd3JpdGluZyBzb21lIGxvZ3MsXG4gICAgICogcHJldmVudCBub2RlX21vZHVsZXMgZnJvbSBiZWluZyBkZWxldGVkLlxuICAgICAqL1xuICAgIGtpbGxNU0J1aWxkKCkge1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50Q29udGV4dC5wbGF0Zm9ybS5ub2RlTmFtZSAhPT0gJ3dpbjMyJykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBvdXQgPSBzcGF3blxuICAgICAgICAgICAgICAgIC5zeW5jKFxuICAgICAgICAgICAgICAgICAgICAnd21pYycsXG4gICAgICAgICAgICAgICAgICAgIFsncHJvY2VzcycsICd3aGVyZScsICdjYXB0aW9uPVwiTVNCdWlsZC5leGVcIicsICdnZXQnLCAncHJvY2Vzc2lkJ11cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgLnN0ZG91dC50b1N0cmluZygndXRmLTgnKVxuICAgICAgICAgICAgICAgIC5zcGxpdCgnXFxuJyk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cCgvKFxcZCspLywgJ2dtJyk7XG4gICAgICAgICAgICAvLyBObyB3ZSB3aWxsIGNoZWNrIGZvciB0aG9zZSB3aXRoIHRoZSBtYXRjaGluZyBwYXJhbXMuXG4gICAgICAgICAgICBvdXQuZm9yRWFjaCgobGluZSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gcmVnZXguZXhlYyhsaW5lKSB8fCBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoYGtpbGxpbmcgTVNCdWlsZC5leGUgYXQgcGlkOiAke21hdGNoWzFdfWApO1xuICAgICAgICAgICAgICAgICAgICBzcGF3bi5zeW5jKCd0YXNra2lsbCcsIFsnL3BpZCcsIG1hdGNoWzFdLCAnL2YnLCAnL3QnXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlZ2V4Lmxhc3RJbmRleCA9IDA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ2tpbGwgTVNCdWlsZCBmYWlsZWQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIHBhdGggdG8gcGFja2FnZWQgYXBwLlxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAgICovXG4gICAgZ2V0UGFja2FnZWRBcHBQYXRoKGNvbnRleHQgPSB7fSkge1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50Q29udGV4dC5wbGF0Zm9ybS5ub2RlTmFtZSA9PT0gJ2RhcndpbicpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICAgICAgICAgICAgdGhpcy5pbnN0YWxsZXJEaXIsXG4gICAgICAgICAgICAgICAgYCR7Y29udGV4dC5wYWNrYWdlci5hcHBJbmZvLnByb2R1Y3RGaWxlbmFtZX0uYXBwYCxcbiAgICAgICAgICAgICAgICAnQ29udGVudHMnLCAnUmVzb3VyY2VzJywgJ2FwcCdcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGxhdGZvcm1EaXIgPVxuICAgICAgICAgICAgYCR7dGhpcy5jdXJyZW50Q29udGV4dC5wbGF0Zm9ybS5ub2RlTmFtZSA9PT0gJ3dpbjMyJyA/ICd3aW4nIDogJ2xpbnV4J30tJHt0aGlzLmN1cnJlbnRDb250ZXh0LmFyY2ggPT09ICdpYTMyJyA/ICdpYTMyLScgOiAnJ311bnBhY2tlZGA7XG4gICAgICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICAgICAgICB0aGlzLmluc3RhbGxlckRpcixcbiAgICAgICAgICAgIHBsYXRmb3JtRGlyLFxuICAgICAgICAgICAgJ3Jlc291cmNlcycsICdhcHAnXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT24gV2luZG93cyBpdCB3YWl0cyBmb3IgdGhlIGFwcC5hc2FyIGluIHRoZSBwYWNrZWQgYXBwIHRvIGJlIGZyZWUgKG5vIGZpbGUgbG9ja3MpLlxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIHdhaXQoKSB7XG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRDb250ZXh0LnBsYXRmb3JtLm5vZGVOYW1lICE9PSAnd2luMzInKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYXBwQXNhclBhdGggPSBwYXRoLmpvaW4oXG4gICAgICAgICAgICB0aGlzLmdldFBhY2thZ2VkQXBwUGF0aCgpLFxuICAgICAgICAgICAgJ2FwcC5hc2FyJ1xuICAgICAgICApO1xuICAgICAgICBsZXQgcmV0cmllcyA9IDA7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2soKSB7XG4gICAgICAgICAgICAgICAgZnMub3BlbihhcHBBc2FyUGF0aCwgJ3IrJywgKGVyciwgZmQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0cmllcyArPSAxO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9FTlQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2cuZGVidWcoYHdhaXRpbmcgZm9yIGFwcC5hc2FyIHRvIGJlIHJlYWRhYmxlLCAkeydjb2RlJyBpbiBlcnIgPyBgY3VycmVudGx5IHJlYWRpbmcgaXQgcmV0dXJucyAke2Vyci5jb2RlfWAgOiAnJ31gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0cmllcyA8IDYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBjaGVjaygpLCA0MDAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoYGZpbGUgaXMgbG9ja2VkOiAke2FwcEFzYXJQYXRofWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZnMuY2xvc2VTeW5jKGZkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2hlY2soKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUHJlcGFyZXMgdGhlIHRhcmdldCBvYmplY3QgcGFzc2VkIHRvIHRoZSBlbGVjdHJvbi1idWlsZGVyLlxuICAgICAqXG4gICAgICogQHJldHVybnMge01hcDxQbGF0Zm9ybSwgTWFwPEFyY2gsIEFycmF5PHN0cmluZz4+Pn1cbiAgICAgKi9cbiAgICBwcmVwYXJlVGFyZ2V0cygpIHtcbiAgICAgICAgbGV0IGFyY2ggPSB0aGlzLiQuZW52Lm9wdGlvbnMuaWEzMiA/ICdpYTMyJyA6ICd4NjQnO1xuICAgICAgICBhcmNoID0gdGhpcy4kLmVudi5vcHRpb25zLmFsbEFyY2hzID8gJ2FsbCcgOiBhcmNoO1xuXG4gICAgICAgIGNvbnN0IHRhcmdldHMgPSBbXTtcblxuICAgICAgICBpZiAodGhpcy4kLmVudi5vcHRpb25zLndpbikge1xuICAgICAgICAgICAgdGFyZ2V0cy5wdXNoKFBsYXRmb3JtLldJTkRPV1MpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLiQuZW52Lm9wdGlvbnMubGludXgpIHtcbiAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5MSU5VWCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuJC5lbnYub3B0aW9ucy5tYWMpIHtcbiAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5NQUMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRhcmdldHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBpZiAodGhpcy4kLmVudi5vcy5pc1dpbmRvd3MpIHtcbiAgICAgICAgICAgICAgICB0YXJnZXRzLnB1c2goUGxhdGZvcm0uV0lORE9XUyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuJC5lbnYub3MuaXNMaW51eCkge1xuICAgICAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5MSU5VWCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRhcmdldHMucHVzaChQbGF0Zm9ybS5NQUMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjcmVhdGVUYXJnZXRzKHRhcmdldHMsIG51bGwsIGFyY2gpO1xuICAgIH1cblxuICAgIGFzeW5jIGJ1aWxkKCkge1xuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuJC5kZXNrdG9wLmdldFNldHRpbmdzKCk7XG4gICAgICAgIGlmICghKCdidWlsZGVyT3B0aW9ucycgaW4gc2V0dGluZ3MpKSB7XG4gICAgICAgICAgICB0aGlzLmxvZy5lcnJvcihcbiAgICAgICAgICAgICAgICAnbm8gYnVpbGRlck9wdGlvbnMgaW4gc2V0dGluZ3MuanNvbiwgYWJvcnRpbmcnXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYnVpbGRlck9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBzZXR0aW5ncy5idWlsZGVyT3B0aW9ucyk7XG5cbiAgICAgICAgYnVpbGRlck9wdGlvbnMuYXNhciA9IGZhbHNlO1xuICAgICAgICBidWlsZGVyT3B0aW9ucy5ucG1SZWJ1aWxkID0gdHJ1ZTtcblxuICAgICAgICBidWlsZGVyT3B0aW9ucy5iZWZvcmVCdWlsZCA9IHRoaXMuYmVmb3JlQnVpbGQuYmluZCh0aGlzKTtcbiAgICAgICAgYnVpbGRlck9wdGlvbnMuYWZ0ZXJQYWNrID0gdGhpcy5hZnRlclBhY2suYmluZCh0aGlzKTtcbiAgICAgICAgYnVpbGRlck9wdGlvbnMuZWxlY3Ryb25WZXJzaW9uID0gdGhpcy4kLmdldEVsZWN0cm9uVmVyc2lvbigpO1xuXG4gICAgICAgIGJ1aWxkZXJPcHRpb25zLmRpcmVjdG9yaWVzID0ge1xuICAgICAgICAgICAgYXBwOiB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLnJvb3QsXG4gICAgICAgICAgICBvdXRwdXQ6IHBhdGguam9pbih0aGlzLiQuZW52Lm9wdGlvbnMub3V0cHV0LCB0aGlzLiQuZW52LnBhdGhzLmluc3RhbGxlckRpcilcbiAgICAgICAgfTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoJ2NhbGxpbmcgYnVpbGQgZnJvbSBlbGVjdHJvbi1idWlsZGVyJyk7XG4gICAgICAgICAgICBhd2FpdCBidWlsZChPYmplY3QuYXNzaWduKHtcbiAgICAgICAgICAgICAgICB0YXJnZXRzOiB0aGlzLnByZXBhcmVUYXJnZXRzKCksXG4gICAgICAgICAgICAgICAgY29uZmlnOiBidWlsZGVyT3B0aW9uc1xuICAgICAgICAgICAgfSwgc2V0dGluZ3MuYnVpbGRlckNsaU9wdGlvbnMpKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuJC51dGlscy5leGlzdHModGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5leHRyYWN0ZWROb2RlTW9kdWxlcykpIHtcbiAgICAgICAgICAgICAgICBzaGVsbC5ybSgnLXJmJywgdGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5leHRyYWN0ZWROb2RlTW9kdWxlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMubG9nLmVycm9yKCdlcnJvciB3aGlsZSBidWlsZGluZyBpbnN0YWxsZXI6ICcsIGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTW92ZXMgbm9kZV9tb2R1bGVzIG91dCBvZiB0aGUgYXBwIGJlY2F1c2Ugd2hpbGUgdGhlIGFwcCB3aWxsIGJlIHBhY2thZ2VkXG4gICAgICogd2UgZG8gbm90IHdhbnQgaXQgdG8gYmUgdGhlcmUuXG4gICAgICogQHJldHVybnMge1Byb21pc2U8YW55Pn1cbiAgICAgKi9cbiAgICBtb3ZlTm9kZU1vZHVsZXNPdXQoKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnbW92aW5nIG5vZGVfbW9kdWxlcyBvdXQsIGJlY2F1c2Ugd2UgaGF2ZSB0aGVtIGFscmVhZHkgaW4nICtcbiAgICAgICAgICAgICAgICAnIGFwcC5hc2FyJyk7XG4gICAgICAgICAgICB0aGlzLmtpbGxNU0J1aWxkKCk7XG4gICAgICAgICAgICByZW1vdmVEaXIodGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC50bXBOb2RlTW9kdWxlcylcbiAgICAgICAgICAgICAgICAuY2F0Y2goZSA9PiByZWplY3QoZSkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBzaGVsbC5jb25maWcuZmF0YWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzaGVsbC5jb25maWcudmVyYm9zZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzaGVsbC5tdihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiQuZW52LnBhdGhzLmVsZWN0cm9uQXBwLm5vZGVNb2R1bGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJC5lbnYucGF0aHMuZWxlY3Ryb25BcHAudG1wTm9kZU1vZHVsZXNcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzaGVsbC5jb25maWcucmVzZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLndhaXQoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2hlbGwuY29uZmlnLnJlc2V0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChlID0+IHJlamVjdChlKSlcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiByZW1vdmVEaXIodGhpcy4kLmVudi5wYXRocy5lbGVjdHJvbkFwcC5ub2RlTW9kdWxlcywgMTAwMCkpXG4gICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4gcmVqZWN0KGUpKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMud2FpdCgpKVxuICAgICAgICAgICAgICAgIC5jYXRjaChyZWplY3QpXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzb2x2ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==